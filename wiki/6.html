<!DOCTYPE html>
<html lang="zh-cmn-Hans">
    <head>
        <meta charset=utf-8" />
        <meta name="generator" content="pandoc" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
        <link rel="icon" href="../favicon.ico" />
        <style type="text/css">
            table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
              margin: 0; padding: 0; vertical-align: baseline; border: none; }
            table.sourceCode { width: 100%; line-height: 100%; }
            td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
            td.sourceCode { padding-left: 5px; }
            code > span.kw { color: #0000ff; }
            code > span.ch { color: #008080; }
            code > span.st { color: #008080; }
            code > span.co { color: #008000; }
            code > span.ot { color: #ff4000; }
            code > span.al { color: #ff0000; }
            code > span.er { font-weight: bold; }
        </style>
        <link rel="stylesheet" href="../style.css" />
        <title>获取文件CRC32值</title>
        <meta name="keywords" content="C语言, crc32" />
        <meta name="author" content="Neal" />
        <meta name="date" content="2016-03-21" />
        <meta name="description" content="这是一段获取文件CRC32值的代码，与WinRAR内CRC32值相同。
        ````````````````````````````````````````````````````````````{.c}
        #include <stdio.h>" />
    </head>
    <body>
        <header class="site-header">
            <h2 style="display:none"><a href="/">Neal</a></h2>
            <nav class="site-nav">
                <span class="site-nav-title"><a href="../index.html">Neal</a></span>
                <ul class="site-nav-list">
                    <li class="site-nav-item"><a href="../wiki.html">Wiki</a></li>
                    <li class="site-nav-item"><a href="https://github.com/qianngchn">GitHub</a></li>
                </ul>
            </nav>
        </header>
        <article class="main-content">
            <header>
                <h2>获取文件CRC32值</h2>
                <code style="background-color:white">Category: <a href="../wiki.html#代码片段">代码片段</a> | Tags: C语言, crc32 | Source: <a href="6.markdown">Markdown</a> ----------&gt; <a href=../wiki.html>Back to Wiki</a></code>
            </header>
            <hr/>
<!---title:获取文件CRC32值-->
<!---category:代码片段-->
<!---tags:C语言, crc32-->
<!---author:Neal-->
<!---date:2016-03-21-->

<p>这是一段获取文件CRC32值的代码，与WinRAR内CRC32值相同。</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="ot">#include &lt;stdio.h&gt;</span>
<span class="ot">#include &lt;stdint.h&gt;</span>

<span class="ot">#define CRC32_POLY 0xEDB88320U</span>
<span class="dt">static</span> <span class="dt">uint32_t</span> crc32table[<span class="dv">256</span>];

<span class="dt">static</span> <span class="dt">void</span> crc32table_init(<span class="dt">void</span>) {
    <span class="dt">uint32_t</span> crc32;
    <span class="dt">int</span> i, j;

    <span class="kw">for</span>(i = <span class="dv">0</span>; i &lt; <span class="dv">256</span>; i++) {
        crc32 = i;
        <span class="kw">for</span>(j = <span class="dv">0</span>; j &lt; <span class="dv">8</span>; j++) {
            <span class="kw">if</span>(crc32 &amp; 0x00000001U)
                crc32 = (crc32 &gt;&gt; <span class="dv">1</span>) ^ CRC32_POLY;
            <span class="kw">else</span>
                crc32 = crc32 &gt;&gt; <span class="dv">1</span>;
        }
        crc32table[i] = crc32;
    }
}

<span class="dt">static</span> <span class="dt">uint32_t</span> crc32_buff(<span class="dt">uint32_t</span> crc32init, <span class="dt">uint8_t</span> *buff, <span class="dt">uint32_t</span> buffsize) {
    <span class="dt">uint32_t</span> crc32 = crc32init ^ 0xFFFFFFFFU;
    <span class="kw">while</span>(buffsize--)
        crc32 = (crc32 &gt;&gt; <span class="dv">8</span>) ^ crc32table[(crc32 &amp; 0x000000FFU) ^ *buff++];

    <span class="kw">return</span> crc32 ^ 0xFFFFFFFFU;
}

<span class="dt">uint32_t</span> crc32_file(<span class="dt">const</span> <span class="dt">char</span> *file) {
    <span class="dt">uint32_t</span> size = 0x00100000U;
    <span class="dt">uint8_t</span> buff[size];
    <span class="dt">uint32_t</span> crc32 = <span class="dv">0</span>;
    size_t length;

    FILE *fd = fopen(file, <span class="st">&quot;r&quot;</span>);
    <span class="kw">if</span>(fd == NULL) <span class="kw">return</span> <span class="dv">0</span>;
    crc32table_init();
    <span class="kw">while</span>((length = fread(buff, <span class="kw">sizeof</span>(<span class="dt">uint8_t</span>), size, fd)) &gt; <span class="dv">0</span>)
        crc32 = crc32_buff(crc32, buff, length);
    fclose(fd);

    <span class="kw">return</span> crc32;
}

<span class="dt">int</span> main(<span class="dt">int</span> argc, <span class="dt">char</span> **argv)
{
    <span class="kw">if</span>(argc != <span class="dv">2</span>)
    {
        printf(<span class="st">&quot;Usage: %s file</span><span class="ch">\n</span><span class="st">&quot;</span>, basename(argv[<span class="dv">0</span>]));
        <span class="kw">return</span> <span class="dv">1</span>;
    }

    <span class="dt">uint32_t</span> crc32 = crc32_file(argv[<span class="dv">1</span>]);
    printf(<span class="st">&quot;CRC32: %08X</span><span class="ch">\n</span><span class="st">&quot;</span>, crc32);

    <span class="kw">return</span> <span class="dv">0</span>;
}</code></pre>
            <hr/>
            <footer>
                <code style="background-color:white">Author: Neal | Date: 2016-03-21 ----------&gt; <a href=#>Go to Top</a></code>
            </footer>
        </article>
        <footer class="site-footer">
            <span class="site-footer-owner">Copyright &copy; 2015, <a href="../index.html">Neal</a>. All Rights Reserved.</span>
            <span class="site-footer-credits">Hosted on <a href="https://pages.github.com">Github Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman Theme</a>.</span>
        </footer>
    </body>
</html>
